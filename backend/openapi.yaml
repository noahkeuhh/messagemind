openapi: 3.0.0
info:
  title: AI Flirt Studio API
  description: Backend API for AI Flirt Translator - Credits & Subscription Engine
  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com

servers:
  - url: http://localhost:3001/api
    description: Development server
  - url: https://api.example.com/api
    description: Production server

tags:
  - name: User
    description: User-related endpoints
  - name: Subscription
    description: Subscription management
  - name: Admin
    description: Admin endpoints
  - name: Webhooks
    description: Stripe webhook handlers

paths:
  /health:
    get:
      summary: Health check
      tags: []
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  timestamp:
                    type: string
                    format: date-time

  /user/credits:
    get:
      summary: Get user credits
      tags: [User]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User credits information
          content:
            application/json:
              schema:
                type: object
                properties:
                  user_id:
                    type: string
                    format: uuid
                  credits_remaining:
                    type: integer
                    example: 100
                  daily_limit:
                    type: integer
                    example: 100
                  last_reset_date:
                    type: string
                    format: date-time
        '401':
          description: Unauthorized
        '404':
          description: User not found

  /user/action:
    post:
      summary: Execute analysis action
      tags: [User]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - action_type
              properties:
                action_type:
                  type: string
                  enum: [short_chat, long_chat, image_analysis]
                input_text:
                  type: string
                image_url:
                  type: string
                  format: uri
      responses:
        '200':
          description: Analysis started
          content:
            application/json:
              schema:
                type: object
                properties:
                  analysis_id:
                    type: string
                    format: uuid
                  status:
                    type: string
                    example: queued
                  credits_remaining:
                    type: integer
                  message:
                    type: string
        '400':
          description: Invalid request
        '402':
          description: Insufficient credits
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: insufficient_credits
                  message:
                    type: string
                  credits_needed:
                    type: integer
        '401':
          description: Unauthorized

  /user/buy_pack:
    post:
      summary: Purchase credit pack
      tags: [User]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - pack_id
              properties:
                pack_id:
                  type: string
                  enum: [pack_50, pack_120, pack_300]
      responses:
        '200':
          description: Checkout session created
          content:
            application/json:
              schema:
                type: object
                properties:
                  checkout_url:
                    type: string
                    format: uri
                  session_id:
                    type: string
        '400':
          description: Invalid request
        '404':
          description: Pack not found

  /user/buy_quick_pack:
    post:
      summary: Quick purchase credit pack
      tags: [User]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - pack_id
              properties:
                pack_id:
                  type: string
      responses:
        '200':
          description: Payment intent created
          content:
            application/json:
              schema:
                type: object
                properties:
                  client_secret:
                    type: string
                  payment_intent_id:
                    type: string

  /user/history:
    get:
      summary: Get analysis history
      tags: [User]
      security:
        - bearerAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Analysis history
          content:
            application/json:
              schema:
                type: object
                properties:
                  analyses:
                    type: array
                    items:
                      type: object
                  total:
                    type: integer

  /user/analysis/{id}:
    get:
      summary: Get analysis by ID
      tags: [User]
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Analysis details
        '404':
          description: Analysis not found

  /user/save_reply:
    post:
      summary: Save a reply
      tags: [User]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - reply_text
              properties:
                reply_text:
                  type: string
                reply_type:
                  type: string
                analysis_id:
                  type: string
                  format: uuid
      responses:
        '200':
          description: Reply saved

  /user/saved_replies:
    get:
      summary: Get saved replies
      tags: [User]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of saved replies
          content:
            application/json:
              schema:
                type: object
                properties:
                  replies:
                    type: array
                    items:
                      type: object

  /user/subscribe:
    post:
      summary: Create subscription
      tags: [Subscription]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - tier
              properties:
                tier:
                  type: string
                  enum: [pro, max, vip]
                interval:
                  type: string
                  enum: [month, year]
                  default: month
      responses:
        '200':
          description: Subscription created
          content:
            application/json:
              schema:
                type: object
                properties:
                  subscription_id:
                    type: string
                  client_secret:
                    type: string
                  status:
                    type: string

  /user/cancel_subscription:
    post:
      summary: Cancel subscription
      tags: [Subscription]
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                immediate:
                  type: boolean
                  default: false
      responses:
        '200':
          description: Subscription cancelled

  /webhook/stripe:
    post:
      summary: Stripe webhook handler
      tags: [Webhooks]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Webhook processed
        '400':
          description: Invalid signature

  /admin/metrics:
    get:
      summary: Get admin metrics
      tags: [Admin]
      security:
        - apiKeyAuth: []
      parameters:
        - name: date_from
          in: query
          schema:
            type: string
            format: date
        - name: date_to
          in: query
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Metrics data
          content:
            application/json:
              schema:
                type: object
                properties:
                  total_users:
                    type: integer
                  active_users:
                    type: integer
                  total_credits_sold:
                    type: integer
                  total_revenue_cents:
                    type: integer
                  daily_breakdown:
                    type: array

  /admin/users:
    get:
      summary: List users
      tags: [Admin]
      security:
        - apiKeyAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: List of users

  /admin/adjust_credits:
    post:
      summary: Adjust user credits
      tags: [Admin]
      security:
        - apiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - user_id
                - amount
              properties:
                user_id:
                  type: string
                  format: uuid
                amount:
                  type: integer
                reason:
                  type: string
      responses:
        '200':
          description: Credits adjusted

securitySchemes:
  bearerAuth:
    type: http
    scheme: bearer
    bearerFormat: JWT
  apiKeyAuth:
    type: apiKey
    in: header
    name: x-admin-api-key



